name: Release

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: üßæ Checkout
        uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - name: ‚öôÔ∏è Setup PNPM
        uses: pnpm/action-setup@v4

      - name: üü¢ Setup Node (npmjs)
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm
          registry-url: https://registry.npmjs.org
          always-auth: true

      - name: üì¶ Install
        run: pnpm -w install

      - name: üßë‚Äçüíª npm whoami
        run: |
          npm config set //registry.npmjs.org/:_authToken=${NPM_TOKEN}
          npm whoami
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

      # –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –≤—ã–≤–µ—Å—Ç–∏ –≤–æ—Ä–∫—Å–ø–µ–π—Å—ã (–¥–ª—è –¥–µ–±–∞–≥–∞ –ø—É—Ç–µ–π)
      - name: üìú List workspaces
        run: pnpm -w list -r --depth -1 || true

      - name: üöÄ Create Release PR or Publish
        uses: changesets/action@v1
        with:
          # –ë–µ–∑ —Ñ–∏–ª—å—Ç—Ä–æ–≤: —Å–æ–±–µ—Ä—ë–º –≤—Å–µ –≤–æ—Ä–∫—Å–ø–µ–π—Å—ã, –≥–¥–µ –µ—Å—Ç—å build (–Ω–µ —É–ø–∞–¥—ë—Ç, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç)
          publish: |
            pnpm -r --if-present build
            pnpm changeset publish
          commit: "chore(release): version packages"
          title: "chore(release): version packages"
          createGithubReleases: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
